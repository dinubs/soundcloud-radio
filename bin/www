#!/usr/bin/env node
var debug = require('debug')('soundcloud-radio');
var app = require('../app');

app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
	debug('Express server listening on port ' + server.address().port);
});

var io = require('socket.io')(server);

server.listen(80);

var tracks = [];
var currentStreamUrl = '';
var currentTime = 0;
var currentTrackDuration = 0;
var interval = 50;

io.on('connection', function (socket) {
	socket.on('comment', function(data) {
		console.log(data);
		io.emit('comment', data);
	});
	if (currentStreamUrl) {
		socket.emit('set audio player', {stream: currentStreamUrl, currentTime: currentTime})
	}
	socket.on('add track', function(url) {
		console.log(url.duration);
		currentTrackDuration = url.duration
		tracks.push(url);
		currentStreamUrl = url.stream_url + '?client_id=6e73cbbe5e7edeba75334acbeb81492f';
		console.log(tracks.length);
		currentTime = 0;
		if (currentTrackDuration != 0) {
			setInterval(function() {
				currentTime += interval;
				console.log(currentTime);
				if (currentTime > currentTrackDuration) {
					currentTime = 0;
					io.emit('comment', 'Choosing next track!');
					tracks[i].shift();
					if (tracks.length = 0) {
						io.emit('comment', 'No tracks left in the queue :(');
					}
				}
			}, interval);
			io.emit('set audio player', {stream: currentStreamUrl, currentTime: 0})
		}
	});
});
