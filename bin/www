#!/usr/bin/env node
var debug = require('debug')('soundcloud-radio');
var app = require('../app');

app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
	console.log('Express server listening on port ' + server.address().port);
});

var io = require('socket.io')(server);

server.listen(80);

var tracks = [];
var currentStreamUrl = '';
var currentTime = 0;
var currentTrackDuration = 0;
var interval = 50;
var started = false;

io.on('connection', function (socket) {
	socket.on('comment', function(data) {
		console.log(data);
		io.emit('comment', data);
	});
	if (currentStreamUrl) {
		socket.emit('set audio player', {stream: currentStreamUrl, currentTime: currentTime})
	}
	socket.on('add track', function(url) {
		currentTrackDuration = url.duration
		tracks.push(url);
		currentStreamUrl = url.stream_url + '?client_id=6e73cbbe5e7edeba75334acbeb81492f';
		console.log(tracks.length);
		if (!started) {
			setInterval(function() {
				currentTime += interval;
				// console.log(currentTime / currentTrackDuration * 100);
				if (currentTime > currentTrackDuration) {
					console.log(tracks.length);
					currentTime = 0;
					io.emit('comment', 'Choosing next track!');
					tracks.shift();
					console.log(tracks.length);
					if (tracks.length == 0 && started) {
						io.emit('comment', 'No tracks left in the queue :(');
						started = false;
					} else{
						currentStreamUrl = tracks[0].stream_url + '?client_id=6e73cbbe5e7edeba75334acbeb81492f';
						currentTrackDuration = tracks[0].duration;
						io.emit('set audio player', {stream: currentStreamUrl, currentTime: 0});
						io.emit('comment', 'Now Playing: ' + tracks[0].title);
					}
				}
			}, interval);
			io.emit('set audio player', {stream: currentStreamUrl, currentTime: 0});
			io.emit('comment', 'Now Playing: ' + tracks[0].title);
			started = true;
		}
	});
});